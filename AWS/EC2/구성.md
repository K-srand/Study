### ğŸ“”ì¸í”„ë¼ êµ¬ì¶•ê³¼ CI/CD ì ìš©

- AWS EC2ë¥¼ ì´ìš©í•˜ì—¬ Amazon Linux 2 í™˜ê²½ì˜ ì„œë²„ êµ¬ì¶•
- DB ì„œë²„ëŠ” AWS RDSë¥¼ ì‚¬ìš©í•˜ì˜€ìœ¼ë©°, ë³´ì•ˆì„ ê³ ë ¤í•˜ì—¬ ìš´ì˜ ì„œë²„ë¥¼ í†µí•´ ssh í„°ë„ë§ìœ¼ë¡œ ì ‘ì†ê°€ëŠ¥í•˜ë„ë¡ êµ¬ì¶•
![image](https://sj-obsidian-bucket.s3.ap-northeast-2.amazonaws.com/41291abb5e59bb52996c89ff2296ab88.png)


- Github Webhookì„ ì´ìš©í•˜ì—¬ í•´ë‹¹ branchì— pushí•˜ë©´ ì  í‚¨ìŠ¤ íŒŒì´í”„ë¼ì¸ì´ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆë„ë¡ ì„¤ì •
- ì  í‚¨ìŠ¤ íŒŒì´í”„ë¼ì¸ì€ ê°ê° ë°±ì—”ë“œ, í”„ë¡ íŠ¸ì—”ë“œë¡œ ë‚˜ëˆ„ì–´ ê´€ë¦¬
- ê°ê° í”„ë¡œì íŠ¸ ì•ˆì— ì  í‚¨ìŠ¤ íŒŒì¼, ë„ì»¤íŒŒì¼ê³¼ í”„ë¡ íŠ¸ì—ëŠ” ì¶”ê°€ì ìœ¼ë¡œ nginx ì„¤ì • íŒŒì¼ì„ ì‘ì„±
![image](https://sj-obsidian-bucket.s3.ap-northeast-2.amazonaws.com/473a88631969e2f79119e7951e9c8d2d.png)


![image](https://sj-obsidian-bucket.s3.ap-northeast-2.amazonaws.com/c165d2ed4c1f310e276f15dbfd73cb53.png)


- êµ¬í˜„ ì½”ë“œ(ë°±ì—”ë“œ)
    
    ```java
    pipeline {
        agent any
        environment {
            JAVA_HOME = '/usr/lib/jvm/java-17-amazon-corretto.x86_64'
            PATH = "${JAVA_HOME}/bin:/usr/bin:${env.PATH}"
        }
        stages {
            stage('Checkout') {
                steps {
                    git branch: 'main', url: '<https://github.com/K-srand/Gangwon-do-activity_backend.git>'
                }
            }
    
            stage('Grant Permissions') {
                steps {
                    echo 'gradlewì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì¤‘...'
                    sh 'chmod +x ./gradlew'
                }
            }
    
            stage('Inject Properties') {
                steps {
                    echo 'application.properties íŒŒì¼ì— í™˜ê²½ ë³€ìˆ˜ ì£¼ì… ì¤‘...'
                    withCredentials([
                        [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'AWS_CREDENTAIL', accessKeyVariable: 'AWS_ACCESS_KEY', secretKeyVariable: 'AWS_SECRET_KEY'],
                        usernamePassword(credentialsId: 'SPRING_MAIL_CREDENTAIL', usernameVariable: 'SPRING_MAIL_USERNAME', passwordVariable: 'SPRING_MAIL_PASSWORD')
                    ]) {
                        sh """
                        sed -i 's#\\\\\\${AWS_ACCESS_KEY}#${AWS_ACCESS_KEY}#g' src/main/resources/application.properties
                        sed -i 's#\\\\\\${AWS_SECRET_KEY}#${AWS_SECRET_KEY}#g' src/main/resources/application.properties
                        sed -i 's#\\\\\\${SPRING_MAIL_USERNAME}#${SPRING_MAIL_USERNAME}#g' src/main/resources/application.properties
                        sed -i 's#\\\\\\${SPRING_MAIL_PASSWORD}#${SPRING_MAIL_PASSWORD}#g' src/main/resources/application.properties
                        """
                    }
                }
            }
    
            stage('Build') {
                steps {
                    echo 'í”„ë¡œì íŠ¸ ë¹Œë“œ ì¤‘...'
                    sh './gradlew build' // Gradle ë¹Œë“œ ì‹¤í–‰
                    sh 'ls -al build/libs' // ë¹Œë“œ ê²°ê³¼ í™•ì¸
                }
            }
    
            stage('Docker Build') {
                steps {
                    echo 'Docker ë¹Œë“œ ì¤€ë¹„ ì¤‘...'
                    script {
                        sh 'docker --version' // Docker Buildxê°€ ì„¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
                        echo "Dockerë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                        sh 'docker build -t ksuji/backend-app -f Dockerfile .'
                    }
                }
            }
    
            stage('Docker Push') {
                steps {
                    echo 'Docker Hubì— ë¡œê·¸ì¸ ì¤‘...'
                    withCredentials([
                        string(credentialsId: 'docker-hub-username', variable: 'DOCKER_HUB_USERNAME'),
                        string(credentialsId: 'docker-hub-password', variable: 'DOCKER_HUB_PASSWORD')
                    ]) {
                        sh 'echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USERNAME --password-stdin'
                    }
                    echo "Docker ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œ ì¤‘..."
                    sh 'docker push ksuji/backend-app:latest'
                }
            }
    
            stage('Deploy') {
                steps {
                    echo 'ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì¤‘...'
                    script {
                        sh 'docker stop backend-app || true'
                        sh 'docker rm backend-app || true'
                    }
    
                    sh 'docker run -d -p 4040:4040 --name backend-app ksuji/backend-app:latest'
    
                    echo "Docker ì»¨í…Œì´ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
                }
            }
        }
    }
    ```
    
    ```docker
    FROM openjdk:17-jdk-slim
    VOLUME /tmp
    
    COPY build/libs/*.jar app.jar
    ENTRYPOINT ["java", "-jar", "/app.jar"]
    ```
    
- êµ¬í˜„ ì½”ë“œ(í”„ë¡ íŠ¸ì—”ë“œ)
    
    ```jsx
    pipeline {
        agent none
    
        stages {
            stage('Clone Repository') {
                agent {
                    docker {
                        image 'node:14-alpine'
                        args '-u root'
                    }
                }
                steps {
                    git branch: 'main', url: '<https://github.com/K-srand/Gangwon-do-activity_frontend.git>'
                }
            }
    
            stage('Install Dependencies and Build') {
                agent {
                    docker {
                        image 'node:14-alpine'
                        args '-u root'
                    }
                }
                environment {
                    NODE_OPTIONS = '--max-old-space-size=4096'
                    PATH = "/usr/bin:/usr/local/bin:$PATH"
                }
                steps {
                    sh 'npm config set cache /var/lib/jenkins/.npm --global'
                    sh 'npm config set prefix /var/lib/jenkins/.npm-global --global'
                    sh 'npm install'
                    sh 'CI=false npm run build'
                }
            }
    
            stage('Build Docker Image') {
                agent any
                steps {
                    script {
                        echo 'ë„ì»¤ ë²„ì „ í™•ì¸ ë° ë¹Œë“œ'
                        sh 'docker --version'
                        echo "Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œ ì¤‘..."
                        sh 'docker build -t ksuji/frontend-app:latest -f Dockerfile .'
                    }
                }
            }
    
            stage('Docker Push') {
                agent any
                steps {
                    echo 'Docker Hubì— ë¡œê·¸ì¸ ì¤‘...'
                    withCredentials([
                        string(credentialsId: 'docker-hub-username', variable: 'DOCKER_HUB_USERNAME'),
                        string(credentialsId: 'docker-hub-password', variable: 'DOCKER_HUB_PASSWORD')
                    ]) {
                        sh 'echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USERNAME --password-stdin'
                    }
                    echo "Docker ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œ ì¤‘..."
                    sh 'docker push ksuji/frontend-app:latest'
                }
            }
    
            stage('Deploy') {
                agent any
                steps {
                    script {
                        sh 'docker stop frontend-app || true && docker rm frontend-app || true'
                        sh 'docker run -d --name frontend-app -p 80:80 ksuji/frontend-app:latest'
                    }
                }
            }
        }
    }
    ```
    
    ```docker
    # Step 1: Build the React app
    FROM node:14-alpine as build
    
    WORKDIR /app
    
    # Copy only package.json and package-lock.json first to leverage Docker's cache
    COPY package.json package-lock.json ./
    
    # Install dependencies only if package.json or package-lock.json changes
    RUN npm install
    
    # Copy the rest of the application code
    COPY . ./
    
    # Build the React application
    RUN npm run build
    
    # Step 2: Serve the built app with Nginx
    FROM nginx:alpine
    
    # Copy custom Nginx configuration file
    COPY nginx.conf /etc/nginx/conf.d/default.conf
    
    # Copy the built files from the previous stage
    COPY --from=build /app/build /usr/share/nginx/html
    
    # Expose port 80
    EXPOSE 80
    
    # Start Nginx
    CMD ["nginx", "-g", "daemon off;"]
    ```
    
    ```jsx
    server {
        listen 80;
        server_name 3.36.27.202;
    
        # í”„ë¡ íŠ¸ì—”ë“œ ì •ì  íŒŒì¼ ì„œë¹™
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
    
        # ë°±ì—”ë“œ API ìš”ì²­ì— ëŒ€í•´ CORS í—¤ë” ì¶”ê°€
        location /api/ {
            proxy_pass <http://172.31.3.146:4040>;  # ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆì™€ í†µì‹ 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
    
            # CORS ì„¤ì •
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization';
            add_header 'Access-Control-Allow-Credentials' 'true';  # ìê²© ì¦ëª… í—ˆìš©
    
            # Preflight ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µ ì²˜ë¦¬
            if ($request_method = OPTIONS) {
                return 204;
            }
        }
    
        # ì—ëŸ¬ í˜ì´ì§€ ì„¤ì • (ì„ íƒ ì‚¬í•­)
        error_page 404 /404.html;
        location = /40x.html {
        }
    
        # .env íŒŒì¼ì´ë‚˜ ê¸°íƒ€ ë¯¼ê°í•œ íŒŒì¼ ì ‘ê·¼ ì°¨ë‹¨
        location ~ /\\.env {
            deny all;
        }
    }
    ```